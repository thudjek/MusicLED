<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>MusicLED</title>
    <style>
        body {
            font-family: sans-serif;
            padding: 20px;
        }
        .control-group {
            margin-bottom: 15px;
        }
        label {
            display: block;
            margin-bottom: 5px;
        }
        select, input[type="color"] {
            padding: 5px;
            font-size: 16px;
        }
        #fixedOptions, #runningOptions, #transitionOptions, #bluetoothOptions {
            display: none;
            margin-top: 15px;
        }
        input[type="number"] {
            padding: 5px;
            font-size: 16px;
            width: 80px;
        }
        #colorPickers {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }
        input[type="color"] {
            width: 50px;
            height: 40px;
            cursor: pointer;
        }
        .bt-section {
            border: 1px solid #ddd;
            padding: 15px;
            border-radius: 5px;
            background: #f9f9f9;
        }
        .bt-status {
            padding: 10px;
            margin-bottom: 10px;
            border-radius: 4px;
        }
        .bt-connected {
            background: #d4edda;
            color: #155724;
        }
        .bt-disconnected {
            background: #f8d7da;
            color: #721c24;
        }
        .bt-device-list {
            list-style: none;
            padding: 0;
            margin: 10px 0;
            max-height: 200px;
            overflow-y: auto;
        }
        .bt-device-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px;
            border: 1px solid #ddd;
            margin-bottom: 5px;
            border-radius: 4px;
            background: white;
        }
        .bt-device-name {
            font-weight: bold;
        }
        .bt-device-mac {
            font-size: 12px;
            color: #666;
        }
        .bt-device-info {
            flex: 1;
        }
        button {
            padding: 8px 16px;
            font-size: 14px;
            cursor: pointer;
            border: none;
            border-radius: 4px;
            margin-left: 5px;
        }
        .btn-primary {
            background: #007bff;
            color: white;
        }
        .btn-primary:hover {
            background: #0056b3;
        }
        .btn-primary:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        .btn-danger {
            background: #dc3545;
            color: white;
        }
        .btn-danger:hover {
            background: #c82333;
        }
        .btn-success {
            background: #28a745;
            color: white;
        }
        .scanning-indicator {
            display: none;
            color: #666;
            font-style: italic;
        }
    </style>
</head>
<body>
    <div class="control-group">
        <label for="mode">Mode:</label>
        <select id="mode" name="mode">
            <option value="0" selected>Off</option>
            <option value="1">Fixed</option>
            <option value="2">Running</option>
            <option value="3">Smooth</option>
            <option value="4">Music</option>
        </select>
    </div>

    <div id="fixedOptions">
        <div class="control-group">
            <label for="colorCount">Number of colors:</label>
            <select id="colorCount">
                <option value="1" selected>1</option>
                <option value="2">2</option>
                <option value="3">3</option>
                <option value="4">4</option>
                <option value="5">5</option>
            </select>
        </div>
        <div class="control-group">
            <label>Colors:</label>
            <div id="colorPickers"></div>
        </div>
    </div>

    <div id="runningOptions">
        <div class="control-group">
            <label for="numOfRunningLeds">Number of running LEDs:</label>
            <input type="number" id="numOfRunningLeds" value="1" min="1">
        </div>
        <div class="control-group">
            <label for="runningDelay">Running delay (ms):</label>
            <input type="number" id="runningDelay" value="100" min="1">
        </div>
    </div>

    <div id="transitionOptions">
        <div class="control-group">
            <label for="transitionSteps">Transition steps:</label>
            <input type="number" id="transitionSteps" value="10" min="1">
        </div>
        <div class="control-group">
            <label for="transitionDelay">Transition delay (ms):</label>
            <input type="number" id="transitionDelay" value="50" min="1">
        </div>
    </div>

    <div id="bluetoothOptions">
        <div class="bt-section">
            <h3>Bluetooth Speaker</h3>

            <div class="control-group">
                <button id="btnScan" class="btn-primary" onclick="toggleScanning()">Scan for Devices</button>
                <span id="scanningIndicator" class="scanning-indicator">Scanning...</span>
            </div>

            <div id="connectedDevicesContainer">
                <label>Connected:</label>
                <ul id="connectedDeviceList" class="bt-device-list">
                    <li class="bt-device-item">No devices connected</li>
                </ul>
            </div>

            <div id="pairedDevicesContainer">
                <label>Paired:</label>
                <ul id="pairedDeviceList" class="bt-device-list">
                    <li class="bt-device-item">No paired devices</li>
                </ul>
            </div>

            <div id="discoveredDevicesContainer">
                <label>Discovered:</label>
                <ul id="discoveredDeviceList" class="bt-device-list">
                    <li class="bt-device-item">No devices discovered</li>
                </ul>
            </div>
        </div>
    </div>

    <script>
        const modeSelect = document.getElementById('mode');
        const fixedOptions = document.getElementById('fixedOptions');
        const runningOptions = document.getElementById('runningOptions');
        const transitionOptions = document.getElementById('transitionOptions');
        const bluetoothOptions = document.getElementById('bluetoothOptions');
        const colorCountSelect = document.getElementById('colorCount');
        const colorPickersContainer = document.getElementById('colorPickers');
        const numOfRunningLedsInput = document.getElementById('numOfRunningLeds');
        const runningDelayInput = document.getElementById('runningDelay');
        const transitionStepsInput = document.getElementById('transitionSteps');
        const transitionDelayInput = document.getElementById('transitionDelay');

        // Bluetooth elements
        const btnScan = document.getElementById('btnScan');
        const scanningIndicator = document.getElementById('scanningIndicator');
        const connectedDeviceList = document.getElementById('connectedDeviceList');
        const pairedDeviceList = document.getElementById('pairedDeviceList');
        const discoveredDeviceList = document.getElementById('discoveredDeviceList');

        let isScanning = false;
        let devicePollInterval = null;

        function getColorValues() {
            const colorInputs = colorPickersContainer.querySelectorAll('input[type="color"]');
            return Array.from(colorInputs).map(input => input.value);
        }

        function createColorPickers(count, colors = null) {
            const currentColors = colors || getColorValues();
            colorPickersContainer.innerHTML = '';

            for (let i = 0; i < count; i++) {
                const colorInput = document.createElement('input');
                colorInput.type = 'color';
                colorInput.value = currentColors[i] || '#ff0000';
                colorInput.addEventListener('input', sendModeRequest);
                colorPickersContainer.appendChild(colorInput);
            }
        }

        function updateUI(status) {
            // Set mode dropdown
            modeSelect.value = status.mode.toString();

            // Show/hide options based on mode
            fixedOptions.style.display = status.mode === 1 ? 'block' : 'none';
            runningOptions.style.display = status.mode === 2 ? 'block' : 'none';
            transitionOptions.style.display = status.mode === 3 ? 'block' : 'none';
            bluetoothOptions.style.display = status.mode === 4 ? 'block' : 'none';

            // Load Bluetooth devices when Music mode is selected
            if (status.mode === 4) {
                loadBluetoothDevices();
            }

            // Set Fixed mode options
            if (status.fixedColors && status.fixedColors.length > 0) {
                colorCountSelect.value = status.fixedColors.length.toString();
                createColorPickers(status.fixedColors.length, status.fixedColors);
            } else {
                createColorPickers(1);
            }

            // Set Running mode options
            if (status.numOfRunningLeds) {
                numOfRunningLedsInput.value = status.numOfRunningLeds;
            }

            if (status.runningDelay) {
                runningDelayInput.value = status.runningDelay;
            }

            if (status.transitionSteps) {
                transitionStepsInput.value = status.transitionSteps;
            }

            if (status.transitionDelay) {
                transitionDelayInput.value = status.transitionDelay;
            }
        }

        async function loadStatus() {
            try {
                const response = await fetch('/status');
                const status = await response.json();
                updateUI(status);
            } catch (error) {
                console.error('Failed to load status:', error);
                createColorPickers(1);
            }
        }

        async function sendModeRequest() {
            const mode = parseInt(modeSelect.value);
            const isFixedMode = mode === 1;
            const isRunningMode = mode === 2;
            const isSmoothMode = mode === 3;

            const request = {
                mode: mode,
                fixedColors: isFixedMode ? getColorValues() : null,
                numOfRunningLeds: isRunningMode ? parseInt(numOfRunningLedsInput.value) : 0,
                runningDelay: isRunningMode ? parseInt(runningDelayInput.value) : 0,
                transitionSteps: isSmoothMode ? parseInt(transitionStepsInput.value) : 0,
                transitionDelay: isSmoothMode ? parseInt(transitionDelayInput.value) : 0
            };

            try {
                await fetch('/mode', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(request)
                });
            } catch (error) {
                console.error('Failed to set mode:', error);
            }
        }

        modeSelect.addEventListener('change', () => {
            const mode = parseInt(modeSelect.value);
            fixedOptions.style.display = mode === 1 ? 'block' : 'none';
            runningOptions.style.display = mode === 2 ? 'block' : 'none';
            transitionOptions.style.display = mode === 3 ? 'block' : 'none';
            bluetoothOptions.style.display = mode === 4 ? 'block' : 'none';

            if (mode === 4) {
                loadBluetoothDevices();
            } else {
                // Stop scanning and polling when leaving Music mode
                stopDevicePolling();
                if (isScanning) {
                    stopScanning();
                }
            }

            sendModeRequest();
        });

        colorCountSelect.addEventListener('change', () => {
            const count = parseInt(colorCountSelect.value);
            createColorPickers(count);
            sendModeRequest();
        });

        numOfRunningLedsInput.addEventListener('input', sendModeRequest);
        runningDelayInput.addEventListener('input', sendModeRequest);
        transitionStepsInput.addEventListener('input', sendModeRequest);
        transitionDelayInput.addEventListener('input', sendModeRequest);

        // Bluetooth Speaker Functions
        async function loadBluetoothDevices() {
            try {
                const response = await fetch('/bluetooth/devices');
                const groups = await response.json();
                updateDeviceGroupsUI(groups);
                updateScanButtonState(groups.isScanning);
            } catch (error) {
                console.error('Failed to load Bluetooth devices:', error);
            }
        }

        function updateDeviceGroupsUI(groups) {
            // Connected devices
            if (groups.connected && groups.connected.length > 0) {
                connectedDeviceList.innerHTML = groups.connected.map(device => `
                    <li class="bt-device-item">
                        <div class="bt-device-info">
                            <div class="bt-device-name">${escapeHtml(device.name)}</div>
                            <div class="bt-device-mac">${device.macAddress}</div>
                        </div>
                        <button class="btn-danger" onclick="disconnectDevice('${device.macAddress}')">Disconnect</button>
                    </li>
                `).join('');
            } else {
                connectedDeviceList.innerHTML = '<li class="bt-device-item">No devices connected</li>';
            }

            // Paired devices (not connected)
            if (groups.paired && groups.paired.length > 0) {
                pairedDeviceList.innerHTML = groups.paired.map(device => `
                    <li class="bt-device-item">
                        <div class="bt-device-info">
                            <div class="bt-device-name">${escapeHtml(device.name)}</div>
                            <div class="bt-device-mac">${device.macAddress}</div>
                        </div>
                        <button class="btn-success" onclick="connectToDevice('${device.macAddress}')">Connect</button>
                    </li>
                `).join('');
            } else {
                pairedDeviceList.innerHTML = '<li class="bt-device-item">No paired devices</li>';
            }

            // Discovered devices (not paired)
            if (groups.discovered && groups.discovered.length > 0) {
                discoveredDeviceList.innerHTML = groups.discovered.map(device => `
                    <li class="bt-device-item">
                        <div class="bt-device-info">
                            <div class="bt-device-name">${escapeHtml(device.name)}</div>
                            <div class="bt-device-mac">${device.macAddress}</div>
                        </div>
                        <button class="btn-success" onclick="connectToDevice('${device.macAddress}')">Connect</button>
                    </li>
                `).join('');
            } else {
                discoveredDeviceList.innerHTML = '<li class="bt-device-item">No devices discovered</li>';
            }
        }

        function updateScanButtonState(scanning) {
            isScanning = scanning;
            if (scanning) {
                btnScan.textContent = 'Stop Scanning';
                btnScan.className = 'btn-danger';
                scanningIndicator.style.display = 'inline';
            } else {
                btnScan.textContent = 'Scan for Devices';
                btnScan.className = 'btn-primary';
                scanningIndicator.style.display = 'none';
            }
        }

        async function toggleScanning() {
            if (isScanning) {
                await stopScanning();
            } else {
                await startScanning();
            }
        }

        async function startScanning() {
            try {
                btnScan.disabled = true;
                await fetch('/bluetooth/scan/start', { method: 'POST' });
                updateScanButtonState(true);
                startDevicePolling();
            } catch (error) {
                console.error('Failed to start scanning:', error);
            } finally {
                btnScan.disabled = false;
            }
        }

        async function stopScanning() {
            try {
                btnScan.disabled = true;
                await fetch('/bluetooth/scan/stop', { method: 'POST' });
                updateScanButtonState(false);
                stopDevicePolling();
            } catch (error) {
                console.error('Failed to stop scanning:', error);
            } finally {
                btnScan.disabled = false;
            }
        }

        function startDevicePolling() {
            stopDevicePolling();
            devicePollInterval = setInterval(loadBluetoothDevices, 2000);
        }

        function stopDevicePolling() {
            if (devicePollInterval) {
                clearInterval(devicePollInterval);
                devicePollInterval = null;
            }
        }

        async function connectToDevice(macAddress) {
            const buttons = document.querySelectorAll('.bt-device-item button');
            buttons.forEach(btn => btn.disabled = true);

            try {
                const response = await fetch('/bluetooth/connect', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ macAddress })
                });

                // Scanning is auto-stopped by the backend, update UI
                updateScanButtonState(false);
                stopDevicePolling();

                if (response.ok) {
                    await loadBluetoothDevices();
                } else {
                    alert('Connection failed. Try putting the device in pairing mode.');
                    await loadBluetoothDevices();
                }
            } catch (error) {
                console.error('Failed to connect:', error);
                alert('Connection error. Please try again.');
            } finally {
                buttons.forEach(btn => btn.disabled = false);
            }
        }

        async function disconnectDevice(macAddress) {
            try {
                await fetch('/bluetooth/disconnect', { method: 'POST' });
                await loadBluetoothDevices();
            } catch (error) {
                console.error('Failed to disconnect:', error);
            }
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        loadStatus();
    </script>
</body>
</html>
